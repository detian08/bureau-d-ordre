# -*- encoding: utf-8 -*-
##############################################################################
#
#    OpenERP, Open Source Management Solution
#    Copyright (C) 2004-2009 Tiny SPRL (<http://tiny.be>). All Rights Reserved
#    $Id$
#
#    This program is free software: you can redistribute it and/or modify
#    it under the terms of the GNU General Public License as published by
#    the Free Software Foundation, either version 3 of the License, or
#    (at your option) any later version.
#
#    This program is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#    GNU General Public License for more details.
#
#    You should have received a copy of the GNU General Public License
#    along with this program.  If not, see <http://www.gnu.org/licenses/>.
#
##############################################################################
import JasperDataParser
from openerp.jasper_reports import jasper_report
from openerp import pooler
import time
import datetime

class jasper_client(JasperDataParser.JasperDataParser):
	def __init__(self, cr, uid, ids, data, context):
		super(jasper_client, self).__init__(cr, uid, ids, data, context)

	def generate_data_source(self, cr, uid, ids, data, context):
		return 'records'

	def generate_parameters(self, cr, uid, ids, data, context):
		return {}

	def generate_properties(self, cr, uid, ids, data, context):
		return {}

	def generate_records(self, cr, uid, ids, data, context):
		print "=====begin======"

		pool = pooler.get_pool(cr.dbname)
		result = []
		if 'form' in data:
			dateAuj = time.strftime('%d-%m-%Y')

			departement_id = data['form']['departement_id'][1]
			date1 = data['form']['date1']
			date2 = data['form']['date2']

			case_section_ids = pool.get('crm.case.section').search(cr, uid, [('name', '=', departement_id)])
			case_section_objs = pool.get('crm.case.section').browse(cr, uid, case_section_ids)

			case_section_name = case_section_objs[0].name

			print "case_section_name",case_section_name
			lead_ids = pool.get('crm.lead').search(cr, uid, [('section_id', '=', departement_id),
																 ('date_debut', '>=', date1),
																 ('date_fin', '<=', date2)
																 ])
			print "*****",lead_ids
			lead_objs = pool.get('crm.lead').browse(cr, uid, lead_ids)
			print "*****lead_objs",lead_objs


#----------------Nombre des commerciaux
			cr.execute("SELECT member_id FROM sale_member_rel WHERE section_id =" + repr(case_section_objs[0].id))
			nb_com = len(cr.fetchall())

			nb_ops_gan = 0
			nb_ops_per = 0
			total_rev_gan = 0
			total_rev_per = 0
			nb_ops = 0

			date_deb = datetime.datetime.strptime(date1, "%Y-%m-%d").strftime('%d-%m-%Y')
			date_fin = datetime.datetime.strptime(date2, "%Y-%m-%d").strftime('%d-%m-%Y')

			if lead_objs:
				print "------",lead_objs
				for lead in lead_objs:
					print "hi lead.stage_id.name ......", lead.stage_id.name
					print "hi lead.stage_id ......", lead.stage_id

					if lead.stage_id.name == "Won":
						print "hi lead.stage_id.name won ",lead.stage_id.name
						nb_ops_gan = nb_ops_gan + 1
						total_rev_gan = total_rev_gan + lead.planned_revenue

					if lead.stage_id.name == "Lost":
						print "hi lead.stage_id.name lost",lead.stage_id.name
						nb_ops_per = nb_ops_per + 1
						total_rev_per = total_rev_per + lead.planned_revenue

				nb_ops = nb_ops_gan + nb_ops_per

				print "nb_ops_gan ",nb_ops_gan
				print "nb_ops_per ",nb_ops_per
				print "nb_ops ",nb_ops

				data = {
					'dateAuj': dateAuj,
					'name': case_section_name,
					'date_deb': date_deb,
					'date_fin': date_fin,
					'nb_ops_gan': repr(nb_ops_gan),
					'total_rev_gan': repr(total_rev_gan) ,
					'nb_ops_per': repr(nb_ops_per),
					'total_rev_per': repr(total_rev_per) ,
					'nb_ops': repr(nb_ops),
					'nb_com': nb_com,
				}
				result.append(data)

				cr.execute("SELECT DISTINCT user_id FROM crm_lead")

				users = cr.fetchall()

				for i in range(len(users)):
					cr.execute("SELECT DISTINCT(res_partner.name) FROM res_partner,res_users, crm_lead "
								"WHERE crm_lead.section_id = "+repr(case_section_objs[0].id) +
								"AND crm_lead.user_id = " + repr(users[i][0]) +
								"AND crm_lead.user_id = res_users.id "
								"AND res_users.partner_id = res_partner.id")
					user_name = cr.fetchall()

					com_lead_ids = pool.get('crm.lead').search(cr, uid,[('user_id', '=', users[i][0]),
																		('section_id', '=', departement_id),
																 		('date_debut', '>=', date1),
																 		('date_fin', '<=', date2)])
					com_lead_objs = pool.get('crm.lead').browse(cr, uid,com_lead_ids)

					if com_lead_objs:
						com_nb_op_gan = 0
						com_total_rev_gan = 0
						com_nb_op_per = 0
						com_total_rev_per = 0
						for lead in com_lead_objs:
							if lead.stage_id.name == "Won":
								com_nb_op_gan = com_nb_op_gan + 1
								com_total_rev_gan = com_total_rev_gan + lead.planned_revenue

							if lead.stage_id.name == "Lost":
								com_nb_op_per = com_nb_op_per + 1
								com_total_rev_per = com_total_rev_per + lead.planned_revenue
						com_nb_ops = com_nb_op_gan + com_nb_op_per

						data ={
							'com_nom': user_name[0][0],
							'com_nb_op': repr(com_nb_ops),
							'com_nb_op_gan':repr(com_nb_op_gan),
							'com_nb_op_per':repr(com_nb_op_per),
							'com_total_rev_gan':repr(com_total_rev_gan) ,
							'com_total_rev_per':repr(com_total_rev_per) ,
						}
						result.append(data)

			else:
				data = {
					'date_deb': date_deb,
					'date_fin': date_fin,
					'dateAuj': dateAuj,
					'name': case_section_name,
					'nb_ops_gan': repr(nb_ops_gan),
					'total_rev_gan': repr(total_rev_gan),
					'nb_ops_per': repr(nb_ops_per),
					'total_rev_per': repr(total_rev_per),
					'nb_ops': repr(nb_ops),
					'nb_com': repr(nb_com),
				}
				result.append(data)


			print repr(result)

		return result


jasper_report.report_jasper('report.jasper_perform_dep_print', 'crm.case.section', parser=jasper_client, )
